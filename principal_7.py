#!/usr/bin/env python3

import paramiko
import codecs
import sys
sys.stderr = open('/dev/null', 'w')
from scapy.all import *


#
# Variables
#

server = 'servertohack.localdomain'
username = 'cartman'
password = 'CFl1X-R35p3c7_my_4u7h0r1t4h'
port = 22222
pcapfile = 'capture_interessante.pcap'
filepath = '/app/' + pcapfile


#
# Get pcap from server via SFTP
#

ssh = paramiko.SSHClient()
ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
ssh.connect(server, username=username, password=password, port=port)
ftp = ssh.open_sftp()
ftp.get(filepath, 'capture_interessante.pcap')
ftp.close()


#
# Analyse pcap with scapy
#

pcap = rdpcap(pcapfile)
sessions = pcap.sessions()
carved_texts = 1
session = 'TCP 192.168.0.1:12345 > 192.168.0.2:80'
packet = sessions[session][19]
header = bytes(packet[Raw].load.decode().split('\r\n')[8].split()[2], 'utf-8')
print(codecs.decode(header, 'base64').decode())
